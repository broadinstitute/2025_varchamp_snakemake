# Computational Image Analysis Methods

## Image Feature Extraction

__CellProfiler.__ We used CellProfiler bioimage analysis software (version 4.2.6) [27] to process the images using classical algorithms following a prior protocol [61]. Illumination variations in images were corrected using the CellProfiler CorrectIlluminationApply module. We segmented nuclei and cells using CellProfiler's IdentifyPrimaryObjects module with Minimum Cross-Entropy thresholding and IdentifySecondaryObjects module with Otsu three-class watershed thresholding, respectively, and measured feature categories including fluorescence intensity, texture, granularity, density, and colocalization between each pair of imaging channels (see http://cellprofiler-manual.s3.amazonaws.com/CellProfiler-4.2.4/index.html for more details) across all segmented compartments and all imaged channels. We obtained 5,640 feature measurements from each of approximately 400 cells per well. We parallelized our image processing workflow using Distributed-CellProfiler [65]. The image analysis pipelines we used are available in the Cell Painting Gallery [66].

## Image Quality Control

To ensure high-quality imaging data, we implemented a comprehensive well-level quality control procedure prior to downstream analyses. For each plate-channel combination, we first calculated the plate-level background as the median pixel intensity (50th percentile) across all wells within that plate and channel. This plate-specific background value serves as the normalization reference to account for systematic variations in microscope illumination, focus drift, and staining batch effects across imaging sessions.

For each individual imaging well, we calculated signal-to-noise ratios (S2N) across all fluorescence channels (DNA/DAPI, AGP/actin, Mito/mitochondrial, and GFP) by computing the ratio of the well's 99th percentile pixel intensity to the plate-specific median background. This S2N metric quantifies the dynamic range of signal in each well relative to the plate-level background, with higher values indicating stronger signal above background noise. The 99th percentile was selected to represent peak signal intensity while being robust to outlier pixels from imaging artifacts.

To transform the wide dynamic range of S2N ratios for downstream analysis, we applied a log10 transformation with a dynamic offset calculated as half the minimum positive S2N value per plate-channel combination. This offset stabilizes variance and handles zero or near-zero values appropriately. We then applied the triangle thresholding method [X] (scikit-image implementation) on the inverted log-transformed S2N distribution to automatically determine channel-specific cutoff values for background detection. This unsupervised approach identifies the inflection point between noise-dominated wells (left tail of the distribution) and signal-dominated wells (right tail) without requiring manual parameter tuning. By inverting the distribution before applying the triangle method, the algorithm identifies wells with insufficient signal as those falling in the original left tail. Wells with log-transformed S2N values below the channel-specific threshold were flagged as background-only wells and excluded from downstream analyses.

For morphological analyses, we aggregated quality control flags across the DNA, AGP, and Mito channels using a maximum operation, such that any well with poor quality in at least one morphological channel was excluded from analysis. The GFP channel was evaluated separately due to its variable expression patterns and role as a validation marker rather than a primary morphological feature. Across 29,184 imaging well-channel combinations spanning all experimental batches, our QC procedure flagged 23.3% of DNA channel wells, 23.6% of GFP channel wells, 13.6% of AGP channel wells, and 17.4% of Mito channel wells as background-only. The aggregated morphological QC excluded approximately 24% of wells from downstream analyses.

## Single-Cell Feature Processing

The overall processing methods generally followed pipelines for population-level profiles that we have developed previously and that are standard practice in image-based profiling. We incorporated additional steps to handle data artifacts unique to single-cell data and ensure robust feature normalization.

### Data Conversion and Annotation
Single-cell feature data were stored in SQLite databases generated by CellProfiler. We converted these databases to Parquet format using cytotable [X] with the "cell-health-cellprofiler-to-cytominer-database" preset, processing data in chunks of 150,000 rows for memory efficiency. The conversion joined Image, Cytoplasm, Cells, and Nuclei tables while preserving cell identifiers (TableNumber, ImageNumber, ObjectNumber). Each plate's single-cell profiles were then annotated with experimental metadata by merging with platemap files containing allele information, well positions, and control designations. Annotated plate-level profiles were aggregated into batch-level files for subsequent processing. Empty wells and transfection control (TC) wells were removed based on metadata annotations.

### Missing Value and Quality Filtering
Missing values were handled using a two-stage filtering approach. First, we replaced infinite values (inf and -inf) with NaN and identified features with more than 100 missing values across all cells. Features exceeding this threshold were removed entirely, while for features with fewer missing values, individual cells containing any remaining NaN values were excluded from analysis. This decision logic prioritizes feature retention while ensuring data completeness. All processed data were validated to confirm no residual NaN or infinite values.

### Normalization and Variant Feature Selection
We computed plate-level summary statistics for each morphological feature, including median, median absolute deviation (MAD), minimum, maximum, and the absolute coefficient of variation (MAD divided by absolute median value). To identify informative features, we selected variant features defined as those with non-zero MAD and absolute coefficient of variation greater than 1×10⁻³ in at least one plate. This criterion removes features with extremely low variance that provide minimal discriminatory power. We then applied RobustMAD normalization [X] by subtracting the plate-specific median from each feature value and dividing by the plate-specific MAD, which robustly removes plate effects while preserving biological variation.

### Outlier Removal and Feature Clipping
To address extreme feature values arising from segmentation errors or imaging artifacts, we identified features where the 99th percentile of absolute values exceeded 100 following normalization. These features were removed from the analysis. For remaining features, we clipped extreme values to the range [-100, +100] to prevent outliers from dominating downstream classification models.

### Feature Selection
We performed feature selection using pycytominer [X] to remove uninformative and redundant features. This included variance thresholding to remove low-variance features, correlation thresholding to remove highly correlated feature pairs (using pycytominer default settings), and blocklist operations to remove known problematic feature families. Features with any remaining missing values after prior filtering steps were also excluded.

### Cell-Level Quality Control
Downstream analysis revealed that segmentation errors occasionally resulted in small debris being identified as cells or multiple cells being merged into a single large object. To filter these artifacts, we computed the ratio of nuclear area to cellular area (Nuclei_AreaShape_Area / Cells_AreaShape_Area) for each cell. Only cells with area ratios between 0.1 and 0.4 were retained, which represents the typical range for mammalian cells. Each cell was assigned a unique identifier by concatenating Plate, Well, ImageNumber, and ObjectNumber. Cells were annotated with control type designations (transfection control TC, negative control NC, positive control PC, corrected positive control cPC, disease wildtype reference disease_wt, or variant allele) based on experimental metadata.

## Variant Classification Analysis

### Experimental Design and Data Preparation
The objective of this analysis was to computationally detect variant alleles with different protein localization patterns than their matched reference alleles. We trained binary XGBoost classifiers [X] to discriminate between single-cell morphological profiles from variant alleles (label = 0) and reference alleles (disease_wt, label = 1) from the same gene. Before classifier training, we performed cell count quality control by removing wells with fewer than 50 cells, which was necessary to ensure sufficient statistical power for training and testing. We extracted feature subsets corresponding to different fluorescence channels (GFP, DNA, AGP, Mito) and a comprehensive morphological feature set (Morph) that excluded GFP, brightfield, and transfection control markers.

### Classifier Configuration and Training
For each reference-variant allele pair, we identified common plates between the two conditions and generated classifiers for all well pairs. We employed a plate-stratified cross-validation strategy where classifiers were trained on data from plates with the same platemap design but tested on the current plate. This approach accounts for technical variation across plates while evaluating classifier performance on independent data. We used the XGBoost algorithm (XGBClassifier) with the following hyperparameters: 150 decision trees, learning rate of 0.05, histogram-based tree construction method (tree_method="hist"), and binary logistic objective function. To handle class imbalance arising from different cell counts between reference and variant wells, we set the scale_pos_weight parameter to the ratio of negative to positive class sizes. Classification was parallelized using 2 CPU cores per classifier.

Variant impact was quantified using the area under the receiver operating characteristic curve (AUROC) as the primary performance metric, with the rationale that variants causing greater subcellular localization perturbations would yield higher-performing classifiers. For each classifier, we also computed area under the precision-recall curve (AUPRC), bias-adjusted AUPRC (AUBPRC), macro F1 score, sensitivity, specificity, and balanced accuracy. We calculated training and testing class imbalance ratios to identify potentially unreliable classifiers.

### Control Classifier Framework
Plate layout impacts image-based profiles, and therefore single-cell profiles from two different wells can usually be partially distinguished even if the perturbation is the same. To estimate the magnitude of this well position effect, we trained an additional set of binary XGBoost classifiers between pairwise combinations of repeated control alleles on each plate. For wells containing the same control allele but at different positions, we generated all pairwise well combinations, constraining analysis to wells appearing on at least 4 plates. This resulted in 144 binary classifiers per batch comparing two wells with different positions but identical alleles (6 control alleles × all pairwise well combinations × 4 platemap configurations). We used the same XGBoost configuration and stratified cross-validation approach as for experimental classifiers.

We defined the upper limit of the well position effect as the 99th percentile of the AUROC distribution from control classifiers within each batch. This threshold represents the maximum classification performance expected from technical variation alone. Initial mislocalization hits were defined as variant-reference pairs with AUROC scores exceeding the batch-specific control threshold. We applied quality control filters by excluding any classifier with training class imbalance greater than 3-fold, as large cell count differences can drive classification independent of morphological changes. We required at least 2 independent classifiers per allele-batch combination to ensure reproducibility. Final mislocalization hits were defined as variants surpassing the well-position threshold in both biological replicate batches, ensuring reproducibility across independent experiments.

### GFP-Intensity Correction
Some genetic variants affect GFP expression levels independent of protein localization. To distinguish morphological changes from expression-driven effects, we implemented an optional GFP-intensity correction pathway. For each reference-variant pair, we performed paired t-tests comparing well-level median GFP intensity (Cells_Intensity_IntegratedIntensity_GFP) between conditions. For pairs showing significant GFP differences, we identified overlapping GFP intensity ranges by testing quantile intervals from (0.25, 0.75) to (0.1, 0.9) and selecting the range that balanced sample sizes while avoiding more than 3-fold class imbalance. We then subsampled cells to matched GFP expression levels and retrained classifiers on this GFP-corrected subset, enabling assessment of morphological changes independent of expression variation.

## Statistical Analysis

We performed three complementary, pre-specified analyses to identify genetic variants causing measurable cellular phenotypes: morphological changes (described above), cell count alterations, and protein abundance changes. All statistical tests were two-sided with significance threshold α = 0.05. Multiple testing correction was performed using the Benjamini-Hochberg false discovery rate (FDR) method [X] as implemented in statsmodels [X].

### Cell Count Analysis
We quantified cell count differences between variant and reference alleles as an indicator of growth or viability phenotypes. Cell counts were calculated as the number of cells passing quality control filters per imaging well. For batches with paired experimental designs (where reference and variant wells appeared on the same plates), we performed paired t-tests (scipy.stats.ttest_rel [X]) comparing cell counts between matched reference-variant pairs. Data were pivoted to wide format with one row per plate to ensure proper pairing. For Batch 11-12, which lacked within-plate pairing, we used Welch's independent t-test (scipy.stats.ttest_ind with equal_var=False). The minimum sample size for inclusion was 3 paired plates (or 6 total observations for independent tests).

Quality control included exclusion of wells flagged as background in the DNA channel, reducing the dataset from 19,966 wells to 18,149 wells after QC. For alleles with measurements across multiple batches, we encountered 195 cases with inconsistent direction of effect (t-statistic sign changes); for these, we reported mean p-values across replicates. We applied Benjamini-Hochberg FDR correction across all tests and defined significant hits as variants with corrected p < 0.05 and t-statistic indicating directional change (negative for decreased cell count, positive for increased cell count). This yielded 257 alleles with significant cell count decreases (18.8% of 1,370 tested alleles) and 226 alleles with significant increases (16.5%) after FDR correction.

### Protein Abundance Analysis
We quantified protein abundance using the median GFP mean intensity per well (Cells_Intensity_MeanIntensity_GFP) with background correction applied by subtracting the plate-specific median background intensity. Similar to cell count analysis, we performed paired t-tests for most batches and independent t-tests for Batch 11-12, with minimum sample sizes of 3 paired plates or 4 total observations. Quality control excluded wells flagged as background in the GFP channel, reducing the dataset from 19,966 wells to 18,352 wells. We identified 119 alleles with inconsistent replicate directions, for which we reported mean statistics.

In addition to statistical significance, we calculated Cohen's d effect size for each comparison, defined as the mean difference divided by the pooled standard deviation. The pooled standard deviation was calculated as the square root of the average of the squared standard deviations from variant and reference conditions. After Benjamini-Hochberg FDR correction, we identified 372 alleles with significant abundance decreases (28.5% of 1,305 tested alleles) and 386 alleles with significant increases (29.6%).

### Classification Performance Analysis
For morphological classification analysis, we calculated AUROC as the primary performance metric for each XGBoost classifier, resulting in approximately 8 classifiers per allele per batch (varying by technical replicates and feature types tested). We applied quality filters requiring training class imbalance less than 3-fold and at least 2 classifiers per allele meeting QC criteria. Wells flagged as background in any morphological channel were excluded from this analysis.

For each batch, we determined AUROC thresholds from the control classifier distribution at the 95th and 99th percentiles. These batch-specific thresholds account for technical variation in plate layout effects. We defined mislocalization hits as variants with mean AUROC exceeding the threshold that also showed consistent classification performance (AUROC above threshold) in both biological replicate batches. We analyzed six feature types: GFP-adjusted (cells subsampled to matched GFP intensity), GFP features only, DNA features only, Mito features only, AGP features only, and comprehensive morphological features (Morph). We assessed reproducibility between biological replicates by calculating Spearman's rank correlation of AUROC values across batches for each feature type.

After removing 50 alleles with incorrect wildtype reference sequences or failed sequence confirmation, the final classification dataset comprised 1,383 allele × batch combinations representing approximately 700 unique genetic variants tested across all batches.

### Sample Sizes and Data Presentation
The study analyzed imaging data from 10 experimental batches spanning 2024-2025: Batch 7-8 (2,200 wells), Batch 11-12 (528 wells), Batch 13-14 (1,368 wells), Batch 15-16 (532 wells), and Batch 18-19 (948 wells), totaling 5,576 wells before quality control. After applying well-level QC filters, sample sizes for final analyses were: 1,370 allele comparisons for cell count analysis, 1,305 for protein abundance analysis, and 1,383 allele × batch combinations for classification analysis.

For cell count and protein abundance analyses, data are presented as mean values when reporting single measurements, with mean statistics used for alleles appearing in multiple batches. Classification results are presented as mean AUROC ± standard deviation across independent classifiers. Both unadjusted and FDR-adjusted p-values are reported for all statistical tests. Effect sizes (Cohen's d) are reported for abundance comparisons to indicate the magnitude of changes beyond statistical significance.

## Computational Environment and Software

All analyses were performed using Python 3.8 with the scientific computing stack including pandas, numpy, polars [X], and scikit-learn [X]. Workflow management was implemented using Snakemake (version 7.32.4) [X] to ensure reproducibility and enable parallelization across computational nodes. Single-cell feature extraction was performed using CellProfiler version 4.2.6 [27].

Data processing utilized cytotable [X] for SQLite-to-Parquet conversion, pycytominer [X] for feature selection operations, and polars [X] for memory-efficient operations on large datasets. Machine learning classification used XGBoost [X] with optional GPU acceleration via CUDA 12.6. Statistical analyses employed SciPy [X] for t-tests and statsmodels [X] for multiple testing correction. Image quality control thresholding used scikit-image [X] implementation of the triangle method. Feature selection and normalization followed standard pycytominer workflows for image-based profiling.

Computational analyses were performed on a high-performance computing cluster with CPU-based parallelization (Snakemake) and optional GPU acceleration for XGBoost training. The complete analysis pipeline, including configuration files and processing scripts, is available at [repository URL]. Processed single-cell profiles and platemap metadata are available in the Cell Painting Gallery [66].